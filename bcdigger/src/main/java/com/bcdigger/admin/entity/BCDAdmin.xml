<?xml version="1.0" encoding="UTF-8"?>

<sqlMap namespace="BCDAdmin">

	<typeAlias alias="bcdAdmin" type="com.bcdigger.admin.entity.AdminEntity"/>
	
	<resultMap class="bcdAdmin" id="result">
		<result property="adminId" column="ADMIN_ID"/>
		<result property="nickname" column="NICKNAME"/>
		<result property="Name" column="NAME"/>
		<result property="password" column="PASSWORD"/>
		<result property="sex" column="SEX" />  <!-- 1男  2 女 -->
 		<result property="age" column="AGE" />  
		<result property="department" column="DEPARTMENT"/>
		<result property="duty" column="DUTY"/>
		<result property="telephone" column="TELEPHONE"/>
		<result property="mobile" column="MOBILE"/>
		<result property="fox" column="FOX"/>
		<result property="email" column="EMAIL"/>
		<result property="address" column="ADDRESS"/>
		<result property="addTime" column="ADD_TIME"/>
		<result property="updateTime" column="UPDATE_TIME"/>
		<result property="state" column="STATE" nullValue="0"/>
		<result property="departmentId" column="DEPARTMENT_ID" nullValue="0"/>
		<result property="openId" column="OPEN_ID"></result>
		<result property="entryDate" column="ENTRY_DATE"></result>
		<result property="userLevel" column="USER_LEVEL"></result>
		
	</resultMap>
	<resultMap class="bcdAdmin" id="simpleResult">
		<result property="userId" column="USER_ID"/>
		<result property="userName" column="USER_NAME"/>
	</resultMap>
	
	<resultMap class="bcdAdmin" id="weixinResult">
		<result property="userId" column="USER_ID"/>
		<result property="openId" column="OPEN_ID"/>
	</resultMap>
	
	<resultMap class="bcdAdmin" id="tresult">
		<result property="email" column="EMAIL"/>
	</resultMap>
	<!-- 用户分页 -->
	<select id="findAdminByPage" parameterClass="bcdAdmin" resultMap="result">
		SELECT 
			   *
		FROM 
			   T_USER
		where 
		USER_NAME like #userName#
		LIMIT  
			#pagination.currentRows#,#pagination.pageSize#
	</select>
	<!-- 分页统计数据 -->
	<select id="countAdminByPage" parameterClass="bcdAdmin"   resultClass="int" >
		SELECT 
			   count(USER_ID)
		FROM 
			   T_USER
		where 
		USER_NAME like #userName#
	</select>
	
	<select id="selectAdminByDepartmentId" parameterClass="bcdAdmin" resultMap="simpleResult">
		SELECT USER_ID, USER_NAME 
		FROM T_USER 
		where STATE=1
		<dynamic prepend="">
			<isGreaterThan prepend="and" property="departmentId" compareValue="0">
				DEPARTMENT_ID = #departmentId# OR DEPARTMENT_ID IN (SELECT ID FROM T_DEPARTMENT WHERE PARENT_ID = #departmentId#)
			</isGreaterThan>
		</dynamic>
	</select>
	
	<select id="selectAllAdmin" resultMap="result" >
		SELECT * FROM T_USER
	</select>
	<!-- 根据用户名查找对象 -->
	<select id="selectAdminByName" resultMap="result" parameterClass="String">
		SELECT * FROM T_USER WHERE USER_NICKNAME=#value#
	</select>
	
	<!-- 根据用户姓名查找对象 -->
	<select id="selectAdminByName" resultMap="tresult" parameterClass="String">
	   SELECT EMAIL FROM T_USER WHERE USER_NAME=#value#
	</select>
	
	<!--根据ID查询用户 -->
	<select id="getUserById" parameterClass="int" resultMap="result">
		SELECT * FROM T_USER WHERE USER_ID =#value#
	</select>
	
		<!-- 插入-->
	<insert id="addUser" parameterClass="tUser">
		INSERT INTO
			T_USER(USER_NICKNAME,USER_NAME,PASSWORD,SEX,AGE,DEPARTMENT,DUTY,TELEPHONE,MOBILE,FOX,EMAIL,ADDRESS,ADD_TIME,UPDATE_TIME,STATE,DEPARTMENT_ID)
		VALUES
			(#userNickname#,#userName#,#password#,#sex#,#age#,#department#,#duty#,#telephone#,#mobile#,#fox#,#email#,#address#,now(),now(),#state#,#departmentId#)
	</insert>

	<!-- 更新 -->
	<update id="updateUserById" parameterClass="tUser">
		UPDATE
			T_USER
		<dynamic prepend="SET">
			<isNotEmpty prepend="," property="openId">OPEN_ID = #openId#</isNotEmpty>
			<isNotEmpty prepend="," property="userNickname">USER_NICKNAME = #userNickname#</isNotEmpty>
			<isNotEmpty prepend="," property="userName">USER_NAME= #userName#</isNotEmpty>
			<isNotEmpty prepend="," property="password">PASSWORD= #password#</isNotEmpty>
			<isGreaterThan prepend="," property="sex" compareValue="0">SEX = #sex#</isGreaterThan>
			<isGreaterThan prepend="," property="age" compareValue="0">AGE = #age#</isGreaterThan>
			<isNotNull prepend="," property="department">DEPARTMENT= #department#</isNotNull>
			<isNotNull prepend="," property="duty">DUTY= #duty#</isNotNull>
			<isNotNull prepend="," property="telephone">TELEPHONE= #telephone#</isNotNull>
			<isNotNull prepend="," property="mobile">MOBILE= #mobile#</isNotNull>
			<isNotNull prepend="," property="fox">FOX= #fox#</isNotNull>
			<isNotNull prepend="," property="email">EMAIL= #email#</isNotNull>
			<isNotNull prepend="," property="address">ADDRESS= #address#</isNotNull>
			<isNull prepend="," property="addTime">ADD_TIME = now()</isNull>
			<isNull prepend="," property="updateTime">UPDATE_TIME = now()</isNull>
			<isGreaterThan prepend="," property="state" compareValue="-1">STATE = #state#</isGreaterThan>
			<isGreaterThan prepend="," property="departmentId" compareValue="0">DEPARTMENT_ID = #departmentId#</isGreaterThan>
		</dynamic>
		WHERE
			USER_ID=#userId#
	</update>
	
	<!-- 删除用户ID删除 -->
	<delete id="deleteUserById" parameterClass="int">
			DELETE FROM T_USER WHERE USER_ID=#value#
	</delete>
	
	
	
	<!-- 分页使用根据 输入的条件  查询数据的集合数 -->
	<select id="getUserCountSelectAll"  resultClass="Integer">
		SELECT count(*)  FROM T_USER
	</select>
	
	
	<!-- 分页使用根据 输入的条件  查询数据的集合 -->
	<select id="getUserList" parameterClass="tUser" resultMap="result" >
		SELECT *  FROM T_USER  order by  USER_ID DESC limit #pagination.currentRows#,#pagination.pageSize#
	</select>
	
	<!-- 更改用户密码 -->
	<update id="updatePasswordById" parameterClass="tUser">
		UPDATE
			T_USER
		<dynamic prepend="SET">
			<isNotEmpty prepend="," property="password">PASSWORD= #password#</isNotEmpty>
			<isNull prepend="," property="updateTime">UPDATE_TIME = now()</isNull>
		</dynamic>
		WHERE
			USER_ID=#userId#
	</update>
	
	<select id="getConcernUserList" resultMap="weixinResult">
		SELECT USER_ID, OPEN_ID FROM T_USER WHERE
		USER_ID IN(SELECT USER_ID FROM T_TASK_VIEW WHERE STATE = 1 GROUP BY USER_ID)
	</select>
	
	<select id="getMilestoneUser" resultMap="weixinResult">
		SELECT USER_ID, OPEN_ID FROM T_USER WHERE
		USER_ID IN(SELECT OWER_ID FROM T_TASK_MILESTONE WHERE STATE = 1 GROUP BY USER_ID)
	</select>
	<select id="getProjectOwnerList" resultMap="weixinResult">
		SELECT USER_ID, OPEN_ID FROM T_USER WHERE
		USER_ID IN(SELECT OWER_ID FROM T_TASK_PROJECT WHERE STATE = 1 GROUP BY USER_ID)
	</select>
	<select id="getConcernListByProjectId" resultMap="weixinResult" parameterClass="Integer">
		SELECT USER_ID, OPEN_ID FROM T_USER WHERE
		USER_ID IN(SELECT USER_ID FROM T_TASK_VIEW WHERE STATE = 1 AND PROJECT_ID=#projectId# GROUP BY USER_ID)
	</select>
	<select id="getWeixinUserById"  resultMap="weixinResult" parameterClass="Integer">
		SELECT USER_ID, OPEN_ID FROM T_USER WHERE
		USER_ID = #userId#
	</select>
	
	<select id="selectUserInfoByOpenId" parameterClass="String" resultMap="result">
	    SELECT 
			*
		FROM 
			   T_USER
		WHERE	   
			   OPEN_ID=#value# limit 1
	 </select>
	
	
</sqlMap>